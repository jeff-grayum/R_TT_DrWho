---
title: "Dr. Who"
author: "Jeff Grayum"
date: "12/12/2021"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Loading libraries.
```{r}
library(tidyverse)
library(tidytuesdayR)
library(scales)
library(ggthemes)
```

Loading data.
```{r}
tuesdata <- tidytuesdayR::tt_load('2021-11-23')

writers <- tuesdata$writers

directors <- tuesdata$directors

episodes <- tuesdata$episodes %>%
  select(-serial_title) %>%
  fill(season_number) %>%
  mutate(episode = paste0(season_number, ".", coalesce(as.character(episode_number, "X")), " ", episode_title),
         episode = fct_reorder(episode, first_aired),
         episode_title = fct_reorder(episode_title, first_aired))

imdb <- tuesdata$imdb
```

First look.
```{r}
episodes %>%
  view()

episodes %>%
  count(type)

episodes %>%
  filter(season_number <= 4) %>%
  ggplot(aes(episode_title, uk_viewers, fill = factor(season_number))) +
  geom_col() +
  theme_tufte() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "",
       y = "# of UK Viewers (millions)",
       fill = "Season",
       title = "UK Viewers per Episode of Dr. Who (Davies years)")

episodes %>%
  filter(season_number <= 4) %>%
  ggplot(aes(episode_title, rating)) +
  geom_line(group = 1) +
  geom_point(aes(color = factor(season_number))) +
  theme_tufte() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "",
       y = "Ave. Rating (IMDb)",
       color = "Season",
       title = "IMDb ratings of Dr. Who episode (Davies years)")


episodes %>%
  ggplot(aes(as.numeric(episode_title), rating)) +
  geom_line(group = 1) +
  geom_point(aes(color = factor(season_number))) +
  geom_smooth(method = "loess") +
  geom_text(aes(label = episode_title), hjust = 1, vjust = 1, check_overlap = TRUE) +
  theme_tufte() +
  theme(axis.text.x = element_blank()) +
  labs(x = "",
       y = "Ave. Rating (IMDb)",
       color = "Season",
       title = "IMDb ratings of Dr. Who episodes")

episodes %>%
  ggplot(aes(as.numeric(episode_title), uk_viewers, fill = factor(season_number))) +
  geom_col() +
  theme_tufte() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "",
       y = "# of UK Viewers (millions)",
       fill = "Season",
       title = "UK Viewers per Episode of Dr. Who")
```

```{r}
summarize_episodes <- function(tbl) {
  tbl %>%
    summarize(avg_rating = mean(rating, na.rm = TRUE),
              avg_viewers = mean(uk_viewers, na.rm = TRUE),
              n_episodes = n(),
              t_test = list(broom::tidy(t.test(rating[!is.na(rating)])))) %>%
    unnest(t_test)
}

episodes %>%
  group_by(season_number) %>%
  summarize_episodes()
```


```{r}
episodes %>%
  inner_join(writers, by = "story_number") %>%
  group_by(writer = fct_lump(writer, 6)) %>%
  summarize_episodes() %>%
  arrange(desc(n_episodes)) %>%
  mutate(writer = fct_reorder(writer, avg_rating)) %>%
  ggplot(aes(avg_rating, writer)) +
  geom_errorbarh(aes(xmin = conf.low, xmax = conf.high), height = 0.1) + 
  geom_point() +
  theme_tufte() +
  labs(x = "Avg rating (95 % CI)",
       y = "Writer",
       title = "Most popular Dr. Who writers")
```

